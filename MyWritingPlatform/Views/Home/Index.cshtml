@{
    ViewData["Title"] = "Home Page";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<!-- Page Header-->
<header class="masthead" style="background-image: url('../assets/img/home-bg.jpg')">
    <div class="container position-relative px-4 px-lg-5">
        <div class="row gx-4 gx-lg-5 justify-content-center">
            <div class="col-md-10 col-lg-8 col-xl-7">
                <div class="site-heading">
                    <h1>The Writing Platform</h1>
                    <span class="subheading">A Blog Writing Platform</span>
                </div>
            </div>
        </div>
    </div>
</header>
<div class="d-flex flex-row justify-content-around">
    <div>
        <div class="dropdown">
            <button class="btn btn-info dropdown-toggle" style="border-radius:8px;" type="button" id="dropdownMenuButton1" data-bs-toggle="dropdown" aria-expanded="false">
                Поиск по Тегу
            </button>
            <ul id="tags" class="dropdown-menu" aria-labelledby="dropdownMenuButton1">
                <li><a class="dropdown-item" href="#">Действие</a></li>
                <li><a class="dropdown-item" href="#">Другое действие</a></li>
                <li><a class="dropdown-item" href="#">Что-то еще здесь</a></li>
            </ul>
        </div>
    </div>
    <div>
        <div class="dropdown">
            <button class="btn btn-info dropdown-toggle" style="border-radius:8px;" type="button" id="dropdownMenuButton2" data-bs-toggle="dropdown" aria-expanded="false">
                Посик по Категории
            </button>
            <ul id="categories" class="dropdown-menu" aria-labelledby="dropdownMenuButton2">
                <li><a class="dropdown-item" href="#">Действие</a></li>
                <li><a class="dropdown-item" href="#">Другое действие</a></li>
                <li><a class="dropdown-item" href="#">Что-то еще здесь</a></li>
            </ul>
        </div>
    </div>
</div>
<br />
<!-- Main Content-->
<div class="container px-4 px-lg-5">
    <div class="row gx-4 gx-lg-5 justify-content-center">
        <div id="block1" class="col-6">
            <!-- Post preview-->
            <div class="post-preview">
                <a href="post.html">
                    <img id="img1" src="~/image/070638444.jpg" style="border-radius: 20px; border: 2px solid #808080; width: 100%;" />
                    <h2 id="title1" class="post-title">Man must explore, and this is exploration at its greatest</h2>
                    <h3 id="short1" class="post-subtitle">Problems look mighty small from 150 miles up</h3>
                </a>
                <p class="post-meta">
                    Опубликовано
                    <a id="name1" href="#!">Start Bootstrap</a>
                    от
                    <span id="date1">24 сентября 2021 г.</span>
                    <img src="~/image/comment-icon.png" style="width:25px; margin-left:5px; margin-right:5px;" /><span id="comment1">10</span>
                </p>
            </div>
            <!-- Divider-->
            <hr class="my-4" />
            <!-- Post preview-->
            <div class="post-preview">
                <a href="post.html">
                    <img id="img3" src="~/image/0_e7ae3_d81b7d27_orig.jpg" style="border-radius: 20px; border: 2px solid #808080; width: 100%;" />
                    <h2 id="title3" class="post-title">I believe every human has a finite number of heartbeats. I don't intend to waste any of mine.</h2>
                    <h3 id="short3" class="post-subtitle">Problems look mighty small from 200 miles up</h3>
                </a>
                <p class="post-meta">
                    Опубликовано
                    <a id="name3" href="#!">Start Bootstrap</a>
                    от
                    <span id="date3">24 сентября 2021 г.</span>
                    <img src="~/image/comment-icon.png" style="width:25px; margin-left:5px; margin-right:5px;" /><span id="comment3">10</span>
                </p>
            </div>
            <!-- Divider-->
            <hr class="my-4" />
            <!-- Post preview-->
            <div class="post-preview">
                <a href="post.html">
                    <img id="img5" src="~/image/14ff85df1c57269926df3fd5f76f8eaf2ba311aa.jpg" style="border-radius: 20px; border: 2px solid #808080; width: 100%;" />
                    <h2 id="title5" class="post-title">Science has not yet mastered prophecy</h2>
                    <h3 id="short5" class="post-subtitle">We predict too much for the next year and yet far too little for the next ten.</h3>
                </a>
                <p class="post-meta">
                    Опубликовано
                    <a id="name5" href="#!">Start Bootstrap</a>
                    от
                    <span id="date5">24 сентября 2021 г.</span>
                    <img src="~/image/comment-icon.png" style="width:25px; margin-left:5px; margin-right:5px;" /><span id="comment5">10</span>
                </p>
            </div>
            <!-- Divider-->
            <hr class="my-4" />
            <!-- Post preview-->
            <div class="post-preview">
                <a href="post.html">
                    <img id="img7" src="~/image/070638444.jpg" style="border-radius: 20px; border: 2px solid #808080; width: 100%;" />
                    <h2 id="title7" class="post-title">Failure is not an option</h2>
                    <h3 id="short7" class="post-subtitle">Many say exploration is part of our destiny, but it’s actually our duty to future generations.</h3>
                </a>
                <p class="post-meta">
                    Опубликовано
                    <a id="name7" href="#!">Start Bootstrap</a>
                    от
                    <span id="date7">24 сентября 2021 г.</span>
                    <img src="~/image/comment-icon.png" style="width:25px; margin-left:5px; margin-right:5px;" /><span id="comment7">10</span>
                </p>
            </div>
            <!-- Divider-->
            <hr class="my-4" />
        </div>
        <div id="block2" class="col-6">
            <!-- Post preview-->
            <div class="post-preview">
                <a href="post.html">
                    <img id="img2" src="~/image/070638444.jpg" style="border-radius: 20px; border: 2px solid #808080; width: 100%;" />
                    <h2 id="title2" class="post-title">Man must explore, and this is exploration at its greatest</h2>
                    <h3 id="short2" class="post-subtitle">Problems look mighty small from 150 miles up</h3>
                </a>
                <p class="post-meta">
                    Опубликовано
                    <a id="name2" href="#!">Start Bootstrap</a>
                    от
                    <span id="date2">24 сентября 2021 г.</span>
                    <img src="~/image/comment-icon.png" style="width:25px; margin-left:5px; margin-right:5px;" /><span id="comment2">10</span>
                </p>
            </div>
            <!-- Divider-->
            <hr class="my-4" />
            <!-- Post preview-->
            <div class="post-preview">
                <a href="post.html">
                    <img id="img4" src="~/image/0_e7ae3_d81b7d27_orig.jpg" style="border-radius: 20px; border: 2px solid #808080; width:100%;" />
                    <h2 id="title4" class="post-title">I believe every human has a finite number of heartbeats. I don't intend to waste any of mine.</h2>
                    <h3 id="short4" class="post-subtitle">Problems look mighty small from 200 miles up</h3>
                </a>
                <p class="post-meta">
                    Опубликовано
                    <a id="name4" href="#!">Start Bootstrap</a>
                    от
                    <span id="date4">24 сентября 2021 г.</span>
                    <img src="~/image/comment-icon.png" style="width:25px; margin-left:5px; margin-right:5px;" /><span id="comment4">10</span>
                </p>
            </div>
            <!-- Divider-->
            <hr class="my-4" />
            <!-- Post preview-->
            <div class="post-preview">
                <a href="post.html">
                    <img id="img6" src="~/image/14ff85df1c57269926df3fd5f76f8eaf2ba311aa.jpg" style="border-radius: 20px; border: 2px solid #808080; width: 100%;" />
                    <h2 id="title6" class="post-title">Science has not yet mastered prophecy</h2>
                    <h3 id="short6" class="post-subtitle">We predict too much for the next year and yet far too little for the next ten.</h3>
                </a>
                <p class="post-meta">
                    Опубликовано
                    <a id="name6" href="#!">Start Bootstrap</a>
                    от
                    <span id="date6">24 сентября 2021 г.</span>
                    <img src="~/image/comment-icon.png" style="width:25px; margin-left:5px; margin-right:5px;" /><span id="comment6">10</span>
                </p>
            </div>
            <!-- Divider-->
            <hr class="my-4" />
            <!-- Post preview-->
            <div class="post-preview">
                <a href="post.html">
                    <img id="img8" src="~/image/070638444.jpg" style="border-radius: 20px; border: 2px solid #808080; width: 100%;" />
                    <h2 id="title8" class="post-title">Failure is not an option</h2>
                    <h3 id="short8" class="post-subtitle">Many say exploration is part of our destiny, but it’s actually our duty to future generations.</h3>
                </a>
                <p class="post-meta">
                    Опубликовано
                    <a id="name8" href="#!">Start Bootstrap</a>
                    от
                    <span id="date8">24 сентября 2021 г.</span>
                    <img src="~/image/comment-icon.png" style="width:25px; margin-left:5px; margin-right:5px;" /><span id="comment8">10</span>
                </p>
            </div>
            <!-- Divider-->
            <hr class="my-4" />
        </div>
        <!-- Pager-->
        <div class="d-flex flex-row justify-content-between">
            <div class="mb-4"><a id="newPost" class="btn btn-primary text-uppercase" style="border-radius:8px; visibility:hidden;" href="#!">← Newer Posts</a></div>
            <div class="mb-4"><a id="oldPost" class="btn btn-primary text-uppercase" style="border-radius:8px;" href="#!">Older Posts →</a></div>
        </div>

    </div>
</div>

<script>

    //Вывод публикаций согласно поиску по Тэгу
    function findPostsTagsList(json, tag) {
        let jsonTags = [];
        for (let i = 0; i < json.length; i++) {
            for (let j = 0; j < json[i].tags.length; j++) {
                if (json[i].tags[j].name == tag)
                    jsonTags.push(json[i]);
            }
        }
        renderPrintList(jsonTags);
    }

    //Заполняем списки тэгов и категорий
    function addTagsCategories(json) {

        let ulT = document.getElementById("tags");
        ulT.innerHTML = "";
        for (let i = 0; i < json[0].tagsName.length; i++) {
            let li = document.createElement("li");
            let a = document.createElement("a");
            a.className = "dropdown-item";
            a.value = json[0].tagsName[i];
            a.innerText = json[0].tagsName[i];
            a.style.cursor = "pointer";
            a.onclick = function () {
                findPostsTagsList(json, this.value);
            };
            li.appendChild(a);
            ulT.appendChild(li);
        }

        let ulC = document.getElementById("categories");
        ulC.innerHTML = "";
        for (let i = 0; i < json[0].categoriesName.length; i++) {
            let li = document.createElement("li");
            let a = document.createElement("a");
            a.className = "dropdown-item";
            a.value = json[0].categoriesName[i];
            a.innerText = json[0].categoriesName[i];
            a.style.cursor = "pointer";
            a.onclick = function () {
                findPostsCategoryList(json, this.value);
            };
            li.appendChild(a);
            ulC.appendChild(li);
        }
    }

    //Создание кода пуликаций
    function createHtmlPosts(json) {
        let block1 = document.getElementById("block1");
        let block2 = document.getElementById("block2");
        block1.innerHTML = "";
        block2.innerHTML = "";

        for (let i = 0; i < json.length; i++) {
            if (json[i].censor == true) {
                let div = document.createElement("div");
                div.className = "post-preview";
                let a1 = document.createElement("a");
                a1.href = "post.html";
                let img = document.createElement("img");
                img.src = json[i].imgPost;
                img.style = "border-radius: 20px; border: 2px solid #808080; width: 100%;";
                a1.appendChild(img);
                let h2 = document.createElement("h2");
                h2.className = "post-title";
                h2.innerText = json[i].title;
                a1.appendChild(h2);
                let h3 = document.createElement("h3");
                h3.className = "post-subtitle";
                h3.innerText = json[i].shortDescription;
                a1.appendChild(h3);
                let p = document.createElement("p");
                p.className = "post-meta";
                let span0 = document.createElement("span");
                span0.innerText = " Опубликовано ";
                let a2 = document.createElement("a");
                a2.href = "#!";
                a2.innerText = json[i].userName;
                p.appendChild(span0);
                p.appendChild(a2);
                let span1 = document.createElement("span");
                span1.innerText = " от " + json[i].published;
                p.appendChild(span1);
                let img1 = document.createElement("img");
                img1.src = "/image/comment-icon.png";
                img1.style = "width:25px; margin-left:5px; margin-right:5px;";
                p.appendChild(img1);
                let span2 = document.createElement("span");
                span2.innerText = json[i].comCount;
                p.appendChild(span2);
                div.appendChild(a1);
                div.appendChild(p);
                if (i < 4) {
                    block1.appendChild(div);
                    let hr = document.createElement("hr");
                    hr.className = "my-4";
                    block1.appendChild(hr);
                }
                if (i > 3 && i < 8) {
                    block2.appendChild(div);
                    let hr = document.createElement("hr");
                    hr.className = "my-4";
                    block2.appendChild(hr);
                }
            }
        }
    }

    //Разбивка массива
    function breakUpArray(json) {
        //Разбить масив на части для вывода на печать
        let size = 8; //размер подмассива
        let subjson = []; //массив в который будет выведен результат.
        for (let i = 0; i < Math.ceil(json.length / size); i++) {
            subjson[i] = json.slice((i * size), (i * size) + size);
        }
        console.log(subjson);
        return subjson;
    }

    //Вывод публикаций
    function renderPrintList(json) {
        let subjson = breakUpArray(json);

        let oldBtn = document.getElementById("oldPost");
        let newBtn = document.getElementById("newPost");
        let i = 0;
        createHtmlPosts(subjson[i]);
        oldBtn.onclick = function () {
            i++;
            newBtn.style.visibility = "visible";
            createHtmlPosts(subjson[i]);
        }
        newBtn.onclick = function () {
            i--;
            if (i == 0)
                newBtn.style.visibility = "hidden";
            createHtmlPosts(subjson[i]);
        }

    }

    //Заполняем страницу публикациями
    function renderPostsList(json) {
        console.log("Get From Server: ");
        console.log(json);

        addTagsCategories(json);

        renderPrintList(json);
    }


    // Выполнение запроса к серверу
    function fetchGetPosts() {

        fetch("/api/posts") // Пошлем запрос GET (по умолчанию) по марштуру на сервер
            .then(response => response.json()) // Преобразуем ответ в json
            .then(json => renderPostsList(json)) // Передадим данные в метод
            .catch((ex) => { // обрабатываем возможную ошибку
                console.log("Error: " + ex.message);
                console.log("Response: " + ex.response);
            });
    }

    fetchGetPosts();
</script>

